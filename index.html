<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Docker從入門到入迷</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/vs.min.css">
    <link rel="stylesheet" href="css/theme/black.css" id="theme">
    <!--Add support for earlier versions of Internet Explorer -->
    <!--[if lt IE 9]>
	<script src="lib/js/html5shiv.js"></script>
	<![endif]-->
</head>

<body>
    <!-- Wrap the entire slide show in a div using the "reveal" class. -->
    <div class="reveal">
        <!-- Wrap all slides in a single "slides" class -->
        <div class="slides">

            <!-- ALL SLIDES GO HERE -->
            <!-- Each section element contains an individual slide -->
            <section>
                <h1>Docker 從入門到入迷</h1>
            </section>
            <section>
                <h1>
                    <del>Docker 從入門到入魔&#x1f608;</del>
                </h1>
                <p>之魔鬼藏在細節裡</p>
            </section>
            <section>
                <section>
                    <h1>這裡會講到</h1>
                    <h3>
                        <ul>
                            <li>Docker</li>
                            <li>Docker Compose</li>
                        </ul>
                    </h3>
                </section>
                <section>
                    <h1>不會講到</h1>
                    <h3>
                        <ul style="text-align: center">
                            <li style="text-align: left">Kubernates<br/><span>
                            <a href="http://kubernetes.io">http://kubernetes.io</a></span></li>
                            <li style="text-align: left">Mesos<br/><span>
                                <a href="http://mesos.apache.org">http://mesos.apache.org</a></span></li>
                        </ul>
                    </h3>
                    <p>以及其他很複雜但除範例之外<br/>不知道怎麼跑起來的方案&#x1f60f;</p>
                </section>
            </section>
            <section>
                <section>
                    <p>大家都說<b style="font-size:200%">容器化</b>是未來趨勢...</p>
                </section>
                <section>
                    <p>但我們只有一堆Copy & Paste的Server端<b style="font-size:200%">舊程式</b>...</p>
                </section>
                <section>
                    <p>要用怎樣的方法來最小幅度<b style="font-size:200%">改造</b>舊程式， 以便能夠用
                        <b><a href="https://github.com/docker/docker">Docker</a></b> + <b><a href="https://github.com/docker/compose">Docker Compose</a></b>的組合，
                        配合內部架設
                        <b><a href="https://github.com/docker/distribution">Docker影像庫</a></b>來做開發時期的維護及營運時期的運行。</p>
                </section>
            </section>
            <section>
                <section>
                    <p>首先來說為何要<b style="font-size:150%">容器化</b>...</p>
                </section>
                <section>
                    <img data-src="./pic/game_DAU.jpg" />
                    <small class="caption">
                        來源：<a href="http://blog.gameanalytics.com/blog/what-analysing-400-games-taught-us.html">http://blog.gameanalytics.com/blog/what-analysing-400-games-taught-us.html</a>
                    </small>
                    <p class="fragment fade-up" style="font-size:120%">從正式上線營運開始後三星期到一個月之間是<br/>關鍵<span style="font-size:120%">&#x1f4b0;</span>觀察期</p>
                </section>
                <section>
                    <h2>
                        流量特性：
                    </h2>
                    <h3>
                        <ul style="margin: 0px">
                            <li class="fragment fade-up" data-fragment-index="1">
                                <div style="white-space: nowrap;">一開始會有暴衝流量(衝首發)</div>
                            </li>
                            <li class="fragment fade-up" data-fragment-index="2">
                                <div style="white-space: nowrap;">如果紅了還會繼續暴衝(病毒式傳播)</div>
                            </li>
                            <li class="fragment fade-up" data-fragment-index="3">
                                <div style="white-space: nowrap;">如果不紅就會掉得很快(該撤收了)</div>
                            </li>
                            <li class="fragment fade-up" data-fragment-index="4">
                                <div style="white-space: nowrap;">真的不紅主動減少維護人力硬體等開銷</div><small class="fragment fade-up" data-fragment-index="5">(自動營運)</small>
                            </li>
                        </ul>
                    </h3>
                    <h3 class="fragment fade-up" data-fragment-index="6">如何根據實際情況有效配置硬體資源讓營運成本降低？</h3>
                </section>
                <section>
                    <h1>
                        讓伺服器配置有彈性
                    </h1>
                    <h3>
                        <ul>
                            <li class="fragment fade-up">
                                <div style="white-space: nowrap;">安裝佈署的方法要很容易&自動化</div>
                            </li>
                            <li class="fragment fade-up">
                                <div style="white-space: nowrap;">遷移到更↑或↓配置的硬體流程簡易&快</div>
                            </li>
                            <li class="fragment fade-up"><br/>
                                <div style="white-space: nowrap;">
                                    <del style="font-weight: lighter">最好還不用多花錢&#x1f4b8;
                                        <del>
                                </div>
                            </li>
                        </ul>
                    </h3>
                </section>
                <section>
                    <h2>
                        Game Table
                    </h2>
                    <h3>
                        <ul>
                            <li class="fragment fade-up" data-fragment-index="1">遊戲系統中佔很大部分的設定檔</li>
                            <li class="fragment fade-up" data-fragment-index="2">遊戲商業邏輯的核心資料</li>
                            <li class="fragment fade-up" data-fragment-index="3">至少一半bug是這類資料沒設定正確導致</li>
                            <li class="fragment fade-up" data-fragment-index="4">要有辦法能在發現錯誤之後快速回溯上個版本重新佈署
                                <small class="fragment fade-up" data-fragment-index="5">(退版)</small></li>
                        </ul>
                    </h3>
                </section>
                <section>
                    <h1>使用Docker做容器化</h1>
                    <ul>
                        <li>Ops:
                            <ul>
                                <li class="fragment fade-up" data-fragment-index="1">伺服器的部署方法完全一致統一化</li>
                                <li class="fragment fade-up" data-fragment-index="2">多個服務要(縮減規模)同時部署在單台硬體上較簡單
                                    <div class="fragment fade-up" data-fragment-index="3">(port mapping且容器內的程式不需改設定)</div>
                                </li>
                                <li class="fragment fade-up" data-fragment-index="4">萬一要退版，藉由Docker的
                                    <a href="https://docs.docker.com/v1.5/terms/layer/#union-file-system">Union File System</a>                                    特性可快速退回先前的狀態來回溯服務狀態
                                </li>
                            </ul>
                        </li>
                        <li>Dev:
                            <ul>
                                <li class="fragment fade-up" data-fragment-index="5"><span style="white-space: nowrap;">開發環境≒營運環境</span>，而且不用花時間自己安裝</li>

                                <li class="fragment fade-up" data-fragment-index="6">不怕過了很久以後要修改程式碼找不到舊版本函式庫&套件工具</li>
                            </ul>
                        </li>
                    </ul>
                </section>
            </section>
            <section>
                <section>
                    <h2>Docker<br/>(docker-engine)<br/>是什麼</h2>
                    <ul>
                        <li class="fragment fade-up" data-fragment-index="1">
                            <div style="white-space: nowrap;">Light Weight VM?</div>
                            <div style="font-size:80%" class="fragment fade-up" data-fragment-index="2">
                                <a href="https://blog.docker.com/2016/03/containers-are-not-vms/">Containers are not VMs</a></div>
                        </li>
                        <li class="fragment fade-up" data-fragment-index="3">
                            <div style="white-space: nowrap;">Runtime?</div>
                        </li>
                        <li class="fragment fade-up" data-fragment-index="4">
                            <div style="white-space: nowrap;">Sandbox?</div>
                        </li>
                        <li class="fragment fade-up" data-fragment-index="5">
                            <div style="white-space: nowrap;">Transport Package Format?</div>
                        </li>
                    </ul>
                    <div style="display: block; position: absolute; top: 0px; left: 0px; width:100%; height: 100%" class="fragment fade-up" data-fragment-index="6">
                        <div class="fragment fade-out" data-fragment-index="7">
                            <img style="width:100%; height: 100%" data-src="./pic/ElephantBlindmen.png" />
                        </div>
                    </div>
                </section>
                <section>
                    <h2>Docker<br/>(docker-engine)<br/>是什麼</h2>
                    <h3 class="fragment fade-up" data-fragment-index="1">不管它是什麼，要做的就是：</h3>
                    <ol>
                        <li class="fragment fade-up" data-fragment-index="2">
                            <div style="white-space: nowrap;">將應用程式執行環境進行<b>包裝</b>產生可佈署的『image』</div>
                        </li>
                        <li class="fragment fade-up" data-fragment-index="3">
                            <div style="white-space: nowrap;">『image』藉由一些步驟導入到目標端機器的docker上</div>
                        </li>
                        <li class="fragment fade-up" data-fragment-index="4">
                            <div style="white-space: nowrap;">『image』在目標端的docker上啟動執行該應用</div>
                        </li>
                    </ol>
                </section>
                <section>
                    <h3>幾個概念</h3>
                    <div style="display: table; width:100%; overflow:hidden;">
                        <div style="display: table-cell; vertical-align: middle;">
                            <img style="display: block; margin: 0px;" data-src="./pic/engine-components-flow.png" /><br/>
                            <small>來源：<a href="https://docs.docker.com/engine/understanding-docker/#/what-is-docker-engine">官網docker-engine</a></small>
                        </div>
                        <div style="display: table-cell; margin-left: 20px; vertical-align: middle; float:right">
                            <ol>
                                <li class="fragment fade-up" data-fragment-index="1">client-server架構</li>
                                <li class="fragment fade-up" data-fragment-index="2">Running Container<small>(run time)</small><br/>
                                    <span class="fragment fade-up" data-fragment-index="3"><small>v.s.</small>
                                        <span/><br/>
                                        <span class="fragment fade-up" data-fragment-index="4">Fixed Image
                                        <small>(build time)</small></span></li>
                                <li class="fragment fade-up" data-fragment-index="5">Union File System分層構造<br/>
                                    <span class="fragment fade-up" data-fragment-index="6">
                                        <small>(for static data & code or exe)</small></span></li>
                                <li class="fragment fade-up" data-fragment-index="7"><a href="https://docs.docker.com/engine/tutorials/dockervolumes/">Volume</a> for state data<br/>
                                    <ul style="font-size: 80%">
                                        <li class="fragment fade-up" data-fragment-index="8">多個容器可以共享單一volume</li>
                                        <li class="fragment fade-up" data-fragment-index="9">容器的volume可以對應到實體機器FS位置</li>
                                        <li class="fragment fade-up" data-fragment-index="10">image產生時可以定義內部路徑位置的volme，並由另一個容器啟動時使用
                                            <br/>(<a href="http://docs.docker.com/engine/reference/run/#/volume-shared-filesystems">--volumes-from</a>)</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>
                    </div>
                </section>
                <section>
                    <h2>Docker Compose<br/>是什麼</h2>
                    <ul>
                        <li class="fragment fade-up" data-fragment-index="1">
                            docker的client端操作單用指令列打命令落落長
                        </li>
                        <li class="fragment fade-up" data-fragment-index="2">運作環境的配置通常不會只有單一個容器</li>
                        <li class="fragment fade-up" data-fragment-index="3">根據執行環境有不同的環境變數&設定檔對應</li>
                    </ul>
                    <div><br/></div>
                    <h4 class="fragment fade-up" data-fragment-index="4">需要有類似Bash Script批次化一堆手工命令操作步驟的工具</h4>
                </section>
                <section>
                    <pre>
                        <code class="hljs yaml">
version: '2'

services:
  <mark>varnish-base</mark>:
    image: ${COMPOSE_PROJECT_NAME}/varnish-base
    build: conf/varnish
    env_file:
      - ./conf/varnish/config/${VILLE_SERV_CONF}/web.env
    volumes:
      - /etc/localtime:/etc/localtime:ro
    expose:
      - "80"

  <mark>nginx-base</mark>:
    image: ${COMPOSE_PROJECT_NAME}/nginx-base
    build: conf/nginx
    env_file:
      - ./env_file/${VILLE_SERV_CONF}.env
    volumes:
      - /etc/localtime:/etc/localtime:ro
    expose:
      - "80"
                        </code>
                    </pre>
                </section>
                <section>
                    <h2>使用Docker Compose的優點</h2>
                    <ul>
                        <li class="fragment fade-up" data-fragment-index="1">
                            多容器運作環境的組態用.yaml檔案控制
                            <ol>
                                <li class="fragment fade-up" data-fragment-index="2"><code>Compose Project</code>目錄&namespace的概念</li>
                                <li class="fragment fade-up" data-fragment-index="3">保證多容器的啟動順序不出錯</li>
                                <li class="fragment fade-up" data-fragment-index="4">.yaml檔案所定義的
                                    <a href="http://docs.docker.com/compose/compose-file/#/service-configuration-reference">容器服務(service)</a>可用繼承的概念來擴展</li>
                            </ol>
                        </li>
                        <li class="fragment fade-up" data-fragment-index="5">受控制的多個容器可批次化進行DOCKER指令操作
                            <code class="fragment fade-up" data-fragment-index="6"><a href="http://docs.docker.com/compose/reference/pull/">docker-compose pull</a></code>&nbsp;&nbsp;&nbsp;&nbsp;
                            <code class="fragment fade-up" data-fragment-index="7"><a href="http://docs.docker.com/compose/reference/push/">docker-compose push</a></code>
                        </li>
                        <li class="fragment fade-up" data-fragment-index="8">配合執行環境可使用不同設定檔對應<br/>
                            <span class="fragment fade-up" data-fragment-index="9">
                            <a href="https://docs.docker.com/compose/compose-file/#/variable-substitution">Variable Substitution</a>
                            </span>
                        </li>
                    </ul>
                </section>
            </section>
            <section>
                <section>
                    <h2>
                        容器化的步驟
                    </h2>
                </section>
                <section>
                    <h3>
                        既有應用程式docker化的方法：
                    </h3>
                    <ol>
                        <li class="fragment fade-up" data-fragment-index="1">寫dockerfile檔以docker build建立出『image』</li>
                        <li class="fragment fade-up" data-fragment-index="2">寫docker-compose.yml檔配置組態</li>
                        <li class="fragment fade-up" data-fragment-index="3">docker-compose up，打完收工</li>
                    </ol>
                    <p class="fragment fade-up" data-fragment-index="4">
                        <del>這麼簡單piece of cake&#x1f370;?!大家可以去吃點心了?!</del>
                    </p>
                    <h4 class="fragment fade-up" data-fragment-index="5">當然不是！&#x1f613;</h4>
                </section>
                <section>
                    <h3>寫dockerfile檔以docker build建立出『image』</h3>
                    <h4 class="fragment fade-up" data-fragment-index="0">如何分層?</h4>
                    <ol>
                        <li class="fragment fade-up" data-fragment-index="1">
                            <div style="white-space: nowrap;">開發技術</div>
                        </li>
                        <li class="fragment fade-up" data-fragment-index="2">
                            <div style="white-space: nowrap;">商業邏輯</div>
                        </li>
                        <li class="fragment fade-up" data-fragment-index="3">
                            <div style="white-space: nowrap;">DevOps流程</div>
                        </li>
                    </ol>
                </section>
                <section>
                    <div style="display: block; position: absolute; top: 0px; left: 0px;">
                        <img style="border: 0px;" data-src="./pic/docker_image_arch.png " />
                    </div>
                    <div style="display: block; position: absolute; top: 0px; left: 0px;"
                     class="fragment fade-in" data-fragment-index="1">
                        <img style="border: 0px;" data-src="./pic/docker_image_arch.png " />
                    </div>
                </section>
                <section>
                    <h4 style="text-align: left; ">實務上在既有應用容器化時會碰到5種類的坑：</h4>
                    <p>
                        <div style="text-align: left; margin: 5px ">
                            <label class="fragment fade-up " data-fragment-index="7 ">0.&nbsp;</label><span class="fragment
                        fade-up " data-fragment-index="6 ">app要跟著轉變，時間會說明一切</span>
                        </div>
                        <div style="text-align: left; margin: 5px ">
                            <label class="fragment fade-up " data-fragment-index="7 ">1.&nbsp;</label><span class="fragment
                        fade-up " data-fragment-index="1 ">設裡面設外面</span>
                        </div>
                        <div style="text-align: left; margin: 5px ">
                            <label class="fragment fade-up " data-fragment-index="7 ">2.&nbsp;</label><span class="fragment
                        fade-up " data-fragment-index="2 ">過個水變權貴</span>
                        </div>
                        <div style="text-align: left; margin: 5px ">
                            <label class="fragment fade-up " data-fragment-index="7 ">3.&nbsp;</label><span class="fragment
                        fade-up " data-fragment-index="3 ">網路卡無極限</span>
                        </div>
                        <div style="text-align: left; margin: 5px ">
                            <label class="fragment fade-up " data-fragment-index="7 ">4.&nbsp;</label><span class="fragment
                        fade-up " data-fragment-index="4 ">Infra自幹有點累</span>
                        </div>
                        <div style="text-align: left; margin: 5px ">
                            <label class="fragment fade-up " data-fragment-index="7 ">5.&nbsp;</label><span class="fragment
                        fade-up " data-fragment-index="5 ">根本不是code的罪</span>
                        </div>
                    </p>
                    <h4 class="fragment fade-up " data-fragment-index="8 ">其他無法歸類的坑也很多......</h4>
                </section>

            </section>
            <section>
                <section>
                    <h2>
                        實際範例Demo
                    </h2>
                </section>
            </section>
        </div>
    </div>
    <script src="lib/js/head.min.js "></script>
    <script src="js/reveal.js "></script>

    <script>
		// Required, even if empty.
		Reveal.initialize({
             // Enable slide navigation via mouse wheel
            mouseWheel: true,
            // Hides the address bar on mobile devices
            hideAddressBar: true,
            slideNumber: 'c/t',
            dependencies: [
                { src: 'plugin/chalkboard/chalkboard.js' },
                { src: '//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js', 
                async: true, callback: function() { 
                    hljs.initHighlightingOnLoad(); 
                }}],
            chalkboard: {
                src: './dev_time_volume.json',
                readOnly: false,
                transition: 800, 
                toggleChalkboardButton: false,
                color: [ 'rgba(255,0,0,1)', 'rgba(255,255,255,0.5)' ]
            },
            keyboard: {
                67: function() { RevealChalkboard.toggleNotesCanvas() },    // toggle notes canvas when 'c' is pressed
                46: function() { RevealChalkboard.clear() },    // clear chalkboard when 'DEL' is pressed
                 8: function() { RevealChalkboard.reset() },    // reset chalkboard data on current slide when 'BACKSPACE' is pressed
                68: function() { RevealChalkboard.download() }, // downlad recorded chalkboard drawing when 'd' is pressed
    },
		});

        if( window.location.search.match( /print-pdf/gi ) ) {
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = 'css/print/pdf.css';
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        }
	</script>
</body>

</html>